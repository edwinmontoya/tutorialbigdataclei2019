# Universidad EAFIT
# Big Data, 2019
# Profesor: Edwin Montoya M. – emontoya@eafit.edu.co
#
# Scripts de HIVE
#

datos de conexión:

Mysql
host: database-1.cj1yhistqein.us-east-2.rds.amazonaws.com
Database: retail_db
Username: retail_dba
Password: retail_dba

importar datos via sqoop por Terminal:

$ sqoop import-all-tables --connect jdbc:mysql://database-1.cj1yhistqein.us-east-2.rds.amazonaws.com:3306/retail_db --username=retail_dba --password=retail_dba --hive-database retail_db --hive-overwrite --hive-import --warehouse-dir=/tmp/retail_dbtmp -m 1 --mysql-delimiters

importar datos via sqoop por HUE:

import-all-tables --connect jdbc:mysql://database-1.cj1yhistqein.us-east-2.rds.amazonaws.com:3306/retail_db --username=retail_dba --password=retail_dba --hive-database retail_db --hive-overwrite --hive-import --warehouse-dir=/tmp/retail_dbtmp -m 1 --mysql-delimiters

-- CATEGORIAS MÁS POPULARES DE PRODUCTOS

> SELECT c.category_name, count(order_item_quantity) as count
FROM order_items oi
inner join products p on oi.order_item_product_id = p.product_id
inner join categories c on c.category_id = p.product_category_id
group by c.category_name
order by count desc
limit 10

-- top 10 de productos que generan ganancias

> SELECT p.product_id, p.product_name, r.revenue
FROM products p inner join
(select oi.order_item_product_id, sum(cast(oi.order_item_subtotal as float)) as revenue
from order_items oi inner join orders o
on oi.order_item_order_id = o.order_id
where o.order_status <> 'CANCELED'
and o.order_status <> 'SUSPECTED_FRAUD'
group by order_item_product_id) r
on p.product_id = r.order_item_product_id
order by r.revenue desc
limit 10

-- SUBIR LOS LOGS AL HDFS:
$ hdfs dfs -put datasets/retail_logs/access.log /user/<username>/datasets/retail_logs/

> use <username>;
> CREATE EXTERNAL TABLE tmp_access_logs (
        ip STRING,
        fecha STRING,
        method STRING,
        url STRING,
        http_version STRING,
        code1 STRING,
        code2 STRING,
        dash STRING,
        user_agent STRING)
    ROW FORMAT SERDE 'org.apache.hadoop.hive.contrib.serde2.RegexSerDe'
    WITH SERDEPROPERTIES (
        'input.regex' = '([^ ]*) - - \\[([^\\]]*)\\] "([^\ ]*) ([^\ ]*) ([^\ ]*)" (\\d*) (\\d*) "([^"]*)" "([^"]*)"',
        'output.format.string' = "%1$$s %2$$s %3$$s %4$$s %5$$s %6$$s %7$$s %8$$s %9$$s")
    LOCATION '/user/<username>/datasets/retail_logs/';

-- CREAR DIRECTORIO PARA TABLA EXTERNA CON ETL
$ hdfs dfs -mkdir /user/<username>/warehouse/access_logs_etl

> CREATE EXTERNAL TABLE etl_access_logs (
        ip STRING,
        fecha STRING,
        method STRING,
        url STRING,
        http_version STRING,
        code1 STRING,
        code2 STRING,
        dash STRING,
        user_agent STRING)
    ROW FORMAT DELIMITED FIELDS TERMINATED BY ','
    LOCATION '/user/<username>/warehouse/access_logs_etl/';


ADD JAR /usr/lib/hive/lib/hive-contrib.jar;


INSERT OVERWRITE TABLE etl_access_logs SELECT * FROM tmp_access_logs;

--- MUESTRE LOS PRODUCTOS MÁS VISITADOS

SELECT count(*) as contador,url FROM etl_access_logs
WHERE url LIKE '%\/product\/%'
GROUP BY url ORDER BY contador DESC LIMIT 10;





CREATE TABLE IF NOT EXISTS `retail_db`.`categories` ( `category_id` INT, `category_department_id` INT, `category_name` STRING) COMMENT 'Imported by sqoop on 2019/10/03 17:44:37' ROW FORMAT DELIMITED FIELDS TERMINATED BY '\054' LINES TERMINATED BY '\012' STORED AS TEXTFILE

CREATE TABLE IF NOT EXISTS `retail_db`.`customers` ( `customer_id` INT, `customer_fname` STRING, `customer_lname` STRING, `customer_email` STRING, `customer_password` STRING, `customer_street` STRING, `customer_city` STRING, `customer_state` STRING, `customer_zipcode` STRING) COMMENT 'Imported by sqoop on 2019/10/03 17:44:57' ROW FORMAT DELIMITED FIELDS TERMINATED BY '\054' LINES TERMINATED BY '\012' STORED AS TEXTFILE

CREATE TABLE IF NOT EXISTS `retail_db`.`departments` ( `department_id` INT, `department_name` STRING) COMMENT 'Imported by sqoop on 2019/10/03 17:45:13' ROW FORMAT DELIMITED FIELDS TERMINATED BY '\054' LINES TERMINATED BY '\012' STORED AS TEXTFILE

CREATE TABLE IF NOT EXISTS `retail_db`.`order_items` ( `order_item_id` INT, `order_item_order_id` INT, `order_item_product_id` INT, `order_item_quantity` TINYINT, `order_item_subtotal` DOUBLE, `order_item_product_price` DOUBLE) COMMENT 'Imported by sqoop on 2019/10/03 17:45:29' ROW FORMAT DELIMITED FIELDS TERMINATED BY '\054' LINES TERMINATED BY '\012' STORED AS TEXTFILE

CREATE TABLE IF NOT EXISTS `retail_db`.`orders` ( `order_id` INT, `order_date` STRING, `order_customer_id` INT, `order_status` STRING) COMMENT 'Imported by sqoop on 2019/10/03 17:45:46' ROW FORMAT DELIMITED FIELDS TERMINATED BY '\054' LINES TERMINATED BY '\012' STORED AS TEXTFILE

CREATE TABLE IF NOT EXISTS `retail_db`.`products` ( `product_id` INT, `product_category_id` INT, `product_name` STRING, `product_description` STRING, `product_price` DOUBLE, `product_image` STRING) COMMENT 'Imported by sqoop on 2019/10/03 17:46:03' ROW FORMAT DELIMITED FIELDS TERMINATED BY '\054' LINES TERMINATED BY '\012' STORED AS TEXTFILE


CREATE EXTERNAL TABLE IF NOT EXISTS `retail_db`.`categories` ( `category_id` INT, `category_department_id` INT, `category_name` STRING) ROW FORMAT DELIMITED FIELDS TERMINATED BY '\054' LINES TERMINATED BY '\012' STORED AS TEXTFILE LOCATION '/user/warehouse/retail_db/categories/';

CREATE EXTERNAL TABLE IF NOT EXISTS `retail_db`.`customers` ( `customer_id` INT, `customer_fname` STRING, `customer_lname` STRING, `customer_email` STRING, `customer_password` STRING, `customer_street` STRING, `customer_city` STRING, `customer_state` STRING, `customer_zipcode` STRING) ROW FORMAT DELIMITED FIELDS TERMINATED BY '\054' LINES TERMINATED BY '\012' STORED AS TEXTFILE  LOCATION '/user/warehouse/retail_db/customers/';

CREATE EXTERNAL TABLE IF NOT EXISTS `retail_db`.`departments` ( `department_id` INT, `department_name` STRING) ROW FORMAT DELIMITED FIELDS TERMINATED BY '\054' LINES TERMINATED BY '\012' STORED AS TEXTFILE LOCATION '/user/warehouse/retail_db/departments/';

CREATE EXTERNAL TABLE IF NOT EXISTS `retail_db`.`order_items` ( `order_item_id` INT, `order_item_order_id` INT, `order_item_product_id` INT, `order_item_quantity` TINYINT, `order_item_subtotal` DOUBLE, `order_item_product_price` DOUBLE) ROW FORMAT DELIMITED FIELDS TERMINATED BY '\054' LINES TERMINATED BY '\012' STORED AS TEXTFILE LOCATION '/user/warehouse/retail_db/order_items/';

CREATE EXTERNAL TABLE IF NOT EXISTS `retail_db`.`orders` ( `order_id` INT, `order_date` STRING, `order_customer_id` INT, `order_status` STRING) ROW FORMAT DELIMITED FIELDS TERMINATED BY '\054' LINES TERMINATED BY '\012' STORED AS TEXTFILE LOCATION '/user/warehouse/retail_db/orders/';

CREATE EXTERNAL TABLE IF NOT EXISTS `retail_db`.`products` ( `product_id` INT, `product_category_id` INT, `product_name` STRING, `product_description` STRING, `product_price` DOUBLE, `product_image` STRING) ROW FORMAT DELIMITED FIELDS TERMINATED BY '\054' LINES TERMINATED BY '\012' STORED AS TEXTFILE LOCATION '/user/warehouse/retail_db/products/';





